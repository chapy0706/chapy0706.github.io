---
// src/pages/posts/index.astro
import Layout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const posts = (await getCollection("posts"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const toYmd = (d: Date) => d.toISOString().slice(0, 10);
const normalize = (t: string) => t.trim().toLowerCase();

const tagCount = new Map<string, number>();
for (const p of posts) {
  for (const t of (p.data.tags ?? []).map(normalize)) {
    if (!t) continue;
    tagCount.set(t, (tagCount.get(t) ?? 0) + 1);
  }
}

const tags = [...tagCount.entries()]
  .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
  .map(([tag, count]) => ({ tag, count }));
---

<Layout title="Posts">
  <main class="container mx-auto px-4 py-10">
    <header class="mb-8">
      <h1 class="text-3xl font-bold">Posts</h1>
      <p class="text-sm opacity-70">書いたもの一覧。</p>

      {tags.length > 0 && (
        <div class="mt-5">
          <div class="flex flex-wrap gap-2 items-center">
            <button
              type="button"
              class="tag-chip tag-chip--active"
              data-tag="__all__"
              aria-pressed="true"
            >
              全部
            </button>

            {tags.map(({ tag, count }) => (
              <a
                class="tag-chip"
                href={`/tags/${encodeURIComponent(tag)}/`}
                data-tag={tag}
              >
                #{tag} <span class="tag-chip__count">({count})</span>
              </a>
            ))}
          </div>

          <p class="mt-2 text-xs opacity-70">
            クリックで絞り込み（JSなしでもタグページに移動できる）。
          </p>
        </div>
      )}
    </header>

    <ul id="posts-grid" class="grid gap-4 md:grid-cols-2">
      {posts.map((post) => (
        <li
          class="post-card rounded-2xl border p-5 hover:shadow-sm transition"
          data-tags={(post.data.tags ?? []).map(normalize).join(",")}
        >
          <a class="block" href={`/posts/${post.slug}/`}>
            <div class="text-sm opacity-70">{toYmd(post.data.pubDate)}</div>
            <div class="mt-1 text-xl font-semibold">{post.data.title}</div>

            {post.data.description && (
              <p class="mt-2 text-sm opacity-80">{post.data.description}</p>
            )}

            {(post.data.tags?.length ?? 0) > 0 && (
              <div class="mt-4 flex flex-wrap gap-2">
                {post.data.tags.map((t) => (
                  <span class="post-tag">#{normalize(t)}</span>
                ))}
              </div>
            )}
          </a>
        </li>
      ))}
    </ul>
  </main>

  <script is:inline>
    {String.raw`
      (function () {
        const grid = document.getElementById('posts-grid');
        if (!grid) return;

        const chipSelector = '[data-tag]';
        const chips = Array.from(document.querySelectorAll(chipSelector));
        const cards = Array.from(grid.querySelectorAll('[data-tags]'));

        const setActive = (activeTag) => {
          for (const chip of chips) {
            const tag = chip.getAttribute('data-tag') || '';
            const isActive = tag === activeTag;
            chip.classList.toggle('tag-chip--active', isActive);
            chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          }
        };

        const apply = (tag) => {
          const t = String(tag || '');
          setActive(t);

          for (const card of cards) {
            const list = (card.getAttribute('data-tags') || '').split(',').filter(Boolean);
            const show = t === '__all__' || list.includes(t);
            card.classList.toggle('is-hidden', !show);
          }
        };

        for (const chip of chips) {
          chip.addEventListener('click', (e) => {
            const tag = chip.getAttribute('data-tag');
            if (chip.tagName.toLowerCase() === 'a') e.preventDefault();
            if (!tag) return;
            apply(tag);
          });
        }

        apply('__all__');
      })();
    `}
  </script>

  <style>
    .tag-chip{
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 9999px;
      padding: .4rem .7rem;
      font-size: .85rem;
      text-decoration: none;
      color: rgba(255,255,255,.78);
      background: rgba(255,255,255,.03);
      transition: background .15s ease, color .15s ease, border-color .15s ease;
      cursor: pointer;
    }
    .tag-chip:hover{
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-color: rgba(255,255,255,.18);
    }
    .tag-chip--active{
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.96);
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 1px rgba(96,165,250,.25) inset;
    }
    .tag-chip__count{ opacity: .75; }

    .post-tag{
      display: inline-flex;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 9999px;
      padding: .18rem .55rem;
      font-size: .75rem;
      color: rgba(255,255,255,.72);
      background: rgba(255,255,255,.02);
    }
    .is-hidden{ display:none; }
  </style>
</Layout>
