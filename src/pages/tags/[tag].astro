---
// src/pages/tags/[tag].astro
import Layout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const normalize = (t: string) => t.trim().toLowerCase();
const toYmd = (d: Date) => d.toISOString().slice(0, 10);

export async function getStaticPaths() {
  const posts = (await getCollection("posts")).filter((p) => !p.data.draft);

  const set = new Set<string>();
  for (const p of posts) {
    for (const t of (p.data.tags ?? []).map(normalize)) {
      if (t) set.add(t);
    }
  }

  return [...set].map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.props as { tag: string };

const posts = (await getCollection("posts"))
  .filter((p) => !p.data.draft)
  .filter((p) => (p.data.tags ?? []).map(normalize).includes(tag))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout title={`Tag: ${tag}`}>
  <main class="container mx-auto px-4 py-10">
    <a class="text-sm opacity-70 hover:opacity-100" href="/tags/">← Tags</a>

    <header class="mt-4 mb-8">
      <h1 class="text-3xl font-bold">#{tag}</h1>
      <p class="text-sm opacity-70">{posts.length} 件</p>
    </header>

    <ul class="grid gap-4 md:grid-cols-2">
      {posts.map((post) => (
        <li class="rounded-2xl border p-5 hover:shadow-sm transition">
          <a class="block" href={`/posts/${post.slug}/`}>
            <div class="text-sm opacity-70">{toYmd(post.data.pubDate)}</div>
            <div class="mt-1 text-xl font-semibold">{post.data.title}</div>
            {post.data.description && (
              <p class="mt-2 text-sm opacity-80">{post.data.description}</p>
            )}
          </a>
        </li>
      ))}
    </ul>
  </main>
</Layout>
